name: fast-forward-merger
run-name: 'üîÄ FF Merge'

on:
  issue_comment:
    types:
      - created

permissions:
  contents: read

jobs:
  comment_checks:
    name: Check FF-Merge Comment
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read
    steps:
      - name: Debug Event
        uses: actions/github-script@v7.0.1
        with:
          script: |
            console.log("%O", `${{ github.event }}`);
            console.log("GH_CTX_EVENT:", `${{ github.event }}`);
            console.log("GH_CTX_ISSUE_COMMENT:", ${{ github.event.pull_request }});
            console.log("GS_CTX_PAYLOAD :", context.payload);

      - name: Check Comment Author üïµÔ∏è
        id: ff_merge_check_valid_commenter
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const commentAuthorAssociation = context.payload.comment.author_association;
            const isMember = commentAuthorAssociation === 'MEMBER';
            console.log(isMember ? 
              '‚úÖ The comment author is a member of the organization.' :
              '‚ùå The comment author is not a member of the organization.'
            );

            if (core.isDebug()) console.log('COMMENT_AUTHOR:', commentAuthorAssociation);

            core.setOutput('valid_commenter', isMember);

      - name: Check Comment Content üìù
        id: ff_merge_check_comment_content
        if: ${{ steps.ff_merge_check_valid_commenter.outputs.valid_commenter }}
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const commentBody = context.payload.comment.body;
            const isValidComment = commentBody === '/ff-merge';
            console.log(isValidComment ? 
              '‚úÖ The comment content is valid.' :
              '‚ùå The comment content is invalid. (Expected: /ff-merge)'
            );

            if (core.isDebug()) console.log('COMMENT_BODY:', commentBody);

            core.setOutput('valid_comment', isValidComment);

      - name: Check Issue Labels üè∑Ô∏è
        id: ff_merge_check_issue_labels
        if: ${{ steps.ff_merge_check_comment_content.outputs.valid_comment }}
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const issueLabels = context.payload.issue.labels;
            const hasFFMergeLabel = issueLabels.some((label) => label.name === 'ff-merge');
            console.log(hasFFMergeLabel ? 
              '‚úÖ The issue has the "fast-forward-merge" label.' :
              '‚ùå The issue does not have the "fast-forward-merge" label.'
            );

            if (core.isDebug()) console.log('ISSUE_LABELS:', issueLabels);

            core.setOutput('valid_label', hasFFMergeLabel);
